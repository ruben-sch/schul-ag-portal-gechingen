{% extends 'base.html' %}

{% block title %}Dashboard - AG-Portal{% endblock %}

{% block content %}
<div class="mb-5 mt-4">
    <h1 class="display-5 text-light mb-2">Willkommen, {{ user.first_name|default:user.email }}!</h1>
    <p class="lead text-secondary">Hier findest du deine aktuellen Anmeldungen und AGs.</p>
</div>

{% if anmeldungen %}
<div class="glass-card p-4 p-md-5 mb-5">
    <h2 class="h3 text-light mb-4 pb-3 border-bottom border-secondary border-opacity-25">Meine Anmeldungen</h2>
    <div class="table-responsive">
        <table class="table table-dark table-hover table-borderless align-middle mb-0" style="background: transparent;">
            <thead class="border-bottom border-secondary border-opacity-50">
                <tr>
                    <th scope="col" class="py-3 text-secondary fw-normal">Kind</th>
                    <th scope="col" class="py-3 text-secondary fw-normal">AG Name</th>
                    <th scope="col" class="py-3 text-secondary fw-normal">Wann</th>
                    <th scope="col" class="py-3 text-secondary fw-normal">Priorit√§t</th>
                    <th scope="col" class="py-3 text-secondary fw-normal">Status</th>
                </tr>
            </thead>
            <tbody class="border-top-0">
                {% for anmeldung in anmeldungen %}
                <tr class="border-bottom border-secondary border-opacity-10">
                    <td class="py-3 text-light fw-medium">{{ anmeldung.schueler.name }}</td>
                    <td class="py-3">{{ anmeldung.ag.name }}</td>
                    <td class="py-3 small text-secondary">{{ anmeldung.ag.get_termine_display }}</td>
                    <td class="py-3 text-center text-md-start">{{ anmeldung.prio }}</td>
                    <td class="py-3">
                        {% if anmeldung.status == 'ACCEPTED' %}
                        <span
                            class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-50 px-3 py-2 rounded-pill">Zugelassen</span>
                        {% elif anmeldung.status == 'REJECTED' %}
                        <span
                            class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-50 px-3 py-2 rounded-pill">Warteliste</span>
                        {% else %}
                        <span
                            class="badge bg-secondary bg-opacity-25 text-light border border-secondary px-3 py-2 rounded-pill">Wartend</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if managed_ags %}
<div class="mt-5">
    <h2 class="h3 text-light mb-4">Deine AG-Verwaltung</h2>

    <div class="row g-4">
        {% for ag in managed_ags %}
        <div class="col-12">
            <div class="glass-card p-4 p-md-5 border-start border-4 border-primary">
                <div class="row align-items-center mb-4 pb-4 border-bottom border-secondary border-opacity-25">
                    <div class="col-12 col-md-8 mb-3 mb-md-0">
                        <h3 class="h4 text-light mb-2">{{ ag.name }}</h3>
                        <div class="text-secondary small mb-2">
                            <strong class="text-light">Wann:</strong> {{ ag.get_termine_display }}
                        </div>
                        <div class="small">
                            <span class="text-secondary me-2">Status:</span>
                            {% if ag.status == 'APPROVED' %}
                            <span class="text-success fw-medium"><i
                                    class="bi bi-check-circle-fill me-1"></i>Genehmigt</span>
                            {% else %}
                            <span class="text-warning"><i class="bi bi-hourglass-split me-1"></i>In Pr√ºfung</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <div class="fs-4 fw-bold text-brand-primary mb-1">{{ ag.total_count }} Bewerber</div>
                        <div class="text-secondary small">Kapazit√§t: {{ ag.kapazitaet }} Pl√§tze</div>
                    </div>
                </div>

                <div class="row g-5">
                    <!-- Teilnehmerliste -->
                    <div class="col-12 col-lg-6">
                        <h4 class="h5 text-light mb-3 pb-2 border-bottom border-success">
                            Zugelassene Teilnehmer
                        </h4>
                        <ul class="list-group list-group-flush bg-transparent">
                            {% for row in ag.accepted_display %}
                            <li
                                class="list-group-item bg-transparent text-light border-secondary border-opacity-25 py-2 px-0">
                                {{ row }}
                            </li>
                            {% empty %}
                            <li class="list-group-item bg-transparent text-secondary border-0 px-0 fst-italic">
                                Noch keine Teilnehmer zugelassen.
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Warteliste -->
                    <div class="col-12 col-lg-6">
                        <h4 class="h5 text-light mb-3 pb-2 border-bottom border-danger">
                            Warteliste <small class="text-secondary fw-normal fs-6">(Abgelehnt / Wartend)</small>
                        </h4>
                        <ul class="list-group list-group-flush bg-transparent">
                            {% for row in ag.waiting_display %}
                            <li
                                class="list-group-item bg-transparent text-light border-secondary border-opacity-25 py-2 px-0">
                                {{ row }}
                            </li>
                            {% empty %}
                            <li class="list-group-item bg-transparent text-secondary border-0 px-0 fst-italic">
                                Keine weiteren Bewerber auf der Warteliste.
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not anmeldungen and not managed_ags %}
<div class="glass-card p-5 text-center mt-5">
    <div class="display-4 mb-3">üì≠</div>
    <p class="lead text-secondary mb-0">Hier gibt es noch nichts zu sehen. Du hast dich noch f√ºr keine AG angemeldet
        oder eine AG eingereicht.</p>
</div>
{% endif %}

<div class="mt-5 text-center text-md-start">
    <form method="post" action="{% url 'admin:logout' %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{% url 'landing' %}">
        <button type="submit" class="btn btn-outline-light px-4">Abmelden</button>
    </form>
</div>
{% endblock %}